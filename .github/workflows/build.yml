# A workflow for testing and creating professional, versioned releases.

name: Build and Release

# Triggers:
# - Push and Pull Requests to master: run tests only.
# - Pushing a new version tag (e.g., v1.2.3): run tests, build, and create a full release.
on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  # Trigger on version tags for releases
  push:
    tags:
      - 'v*.*.*'

env:
  CARGO_TERM_COLOR: always

jobs:
  # This job runs tests on every push to ensure code quality.
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-test-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-test-

      - name: Run tests
        run: cargo test --verbose

  # This job builds the release binaries and creates a professional GitHub Release.
  # It only runs when a version tag is pushed.
  build-and-release:
    name: Build and Release
    needs: test # Wait for the 'test' job to succeed first
    # Only run this job for tags, not for pushes to the master branch
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-release-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-release-

      # Install 'cross' ONLY for the Windows build.
      - name: Install cross
        run: cargo install cross

      # Add the necessary compilation targets for our desired binaries
      - name: Add Rust targets
        run: |
          rustup target add x86_64-pc-windows-gnu    # For Windows x64
          rustup target add aarch64-linux-android    # For Android ARM64

      # Set up the Android NDK, which is required for the Android target
      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        id: ndk
        with:
          ndk-version: r26b

      # Build for Linux x64 (this is the host target, so no 'cross' needed)
      - name: Build for Linux x64
        run: cargo build --release --target x86_64-unknown-linux-gnu

      # Build for Windows x64 using 'cross'
      - name: Build for Windows x64
        run: cross build --release --target x86_64-pc-windows-gnu

      # Build for Android ARM64 by configuring cargo to use the NDK directly.
      - name: Build for Android ARM64
        env:
          # Define the NDK path for easy reference
          NDK_HOME: ${{ steps.ndk.outputs.ndk-path }}
          # Configure the C/C++ compiler and archiver for the build scripts (build.rs)
          CC: aarch64-linux-android33-clang
          CXX: aarch64-linux-android33-clang++
          AR: llvm-ar
          # Configure the Rust linker and library paths for the final linking stage
          CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER: aarch64-linux-android33-clang
          CARGO_TARGET_AARCH64_LINUX_ANDROID_RUSTFLAGS: -L ${NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/aarch64-linux-android/33
        run: |
          # Add the NDK tools to the PATH so the build scripts can find them
          export PATH="${{ steps.ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH"
          cargo build --release --target aarch64-linux-android

      # Prepare the release directory and rename the binaries.
      - name: Prepare release artifacts
        run: |
          mkdir -p release
          cp target/x86_64-unknown-linux-gnu/release/zipsignerust release/zipsignerust-linux-x64
          cp target/x86_64-pc-windows-gnu/release/zipsignerust.exe release/zipsignerust-windows-x64.exe
          cp target/aarch64-linux-android/release/zipsignerust release/zipsignerust-android-arm64

      # Create a new, professional-looking GitHub Release.
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          # The name of the release, e.g., "zipsignerust v1.0.0"
          name: zipsignerust ${{ github.ref_name }}
          # The tag for the release, e.g., "v1.0.0"
          tag_name: ${{ github.ref_name }}
          # The body of the release, with all the fancy branding
          body: |
            ## üöÄ ${{ github.event.repository.name }} ${{ github.ref_name }}
            
            A high-performance, secure, and cross-platform command-line tool for signing ZIP, JAR, and APK files, written in Rust.
            
            **Author:** Tiash H Kabir (@MrCarb0n)
            
            ---
            
            ### ‚ú® What's Changed
            ${{ github.event.head_commit.message }}
            
            ---
            
            ### üì¶ Downloads
            
            Choose the binary for your platform:
            
            | Platform | Binary |
            | :--- | :--- |
            | **Linux x64** | `zipsignerust-linux-x64` |
            | **Windows x64** | `zipsignerust-windows-x64.exe` |
            | **Android ARM64** | `zipsignerust-android-arm64` |
            
            ---
            
            ### üõ†Ô∏è How to Use
            
            1.  Download the correct binary for your system.
            2.  Make it executable (on Linux/macOS): `chmod +x zipsignerust-linux-x64`
            3.  Sign your file! (This example uses the included test keys)
                ```bash
                ./zipsignerust-linux-x64 my-app.apk
                ```
            *For more advanced usage, see the [project README](https://github.com/MrCarb0n/zipsignerust#readme).*
            
            ---
            
            ‚ö†Ô∏è **Note:** This release includes a public test certificate for convenience. For production, you **must** use your own private signing keys.
          # Automatically mark as a pre-release if the tag contains alpha, beta, or rc
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
          # The files to upload as release assets
          files: |
            release/zipsignerust-linux-x64
            release/zipsignerust-windows-x64.exe
            release/zipsignerust-android-arm64
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}