# A workflow for testing and automatically releasing zipsignerust on every push to main.

name: Automatic Release

# Trigger this workflow on every push to the main branch.
on:
  push:
    branches:
      - master

env:
  CARGO_TERM_COLOR: always

jobs:
  # This job runs tests to ensure the code is healthy before building.
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-test-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-test-

      - name: Run tests
        run: cargo test --verbose

  # This job builds the release binaries and updates the 'latest' pre-release.
  build-and-release:
    name: Build and Release
    needs: test # Wait for the 'test' job to succeed first
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-release-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-release-

      # Install 'cross' for easy cross-compilation using Docker
      - name: Install cross
        run: cargo install cross

      # Add the necessary compilation targets for our desired binaries
      - name: Add Rust targets
        run: |
          rustup target add x86_64-pc-windows-gnu    # For Windows x64
          rustup target add aarch64-linux-android    # For Android ARM64

      # Set up the Android NDK, which is required for the Android target
      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        id: ndk
        with:
          ndk-version: r26b

      # Build for Linux x64 (this is the host target, so no 'cross' needed)
      - name: Build for Linux x64
        run: cargo build --release --target x86_64-unknown-linux-gnu

      # Build for Windows x64 using 'cross'
      - name: Build for Windows x64
        run: cross build --release --target x86_64-pc-windows-gnu

      # Build for Android ARM64 using 'cross' and the NDK
      - name: Build for Android ARM64
        env:
          NDK_HOME: ${{ steps.ndk.outputs.ndk-path }}
        run: cross build --release --target aarch64-linux-android

      # Prepare the release directory and rename the binaries.
      # The certs/ directory is already available to the build process.
      - name: Prepare release artifacts
        run: |
          mkdir -p release
          cp target/x86_64-unknown-linux-gnu/release/zipsignerust release/zipsignerust-linux-x64
          cp target/x86_64-pc-windows-gnu/release/zipsignerust.exe release/zipsignerust-windows-x64.exe
          cp target/aarch64-linux-android/release/zipsignerust release/zipsignerust-android-arm64

      # Update the 'latest' pre-release with the new binaries.
      - name: Update Release
        uses: softprops/action-gh-release@v2
        with:
          # This will create or update a pre-release tagged as 'latest'
          tag_name: "latest"
          name: "Development Build"
          body: "Automated build from commit ${{ github.sha }}."
          prerelease: true
          # This will overwrite existing assets with the same name
          files: |
            release/zipsignerust-linux-x64
            release/zipsignerust-windows-x64.exe
            release/zipsignerust-android-arm64
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
