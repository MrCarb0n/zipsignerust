# A workflow for automatically updating the 'latest' release on every push to master.

name: Automatic Latest Release

# Trigger this workflow on every push to the master branch.
on:
  push:
    branches:
      - master

env:
  CARGO_TERM_COLOR: always

jobs:
  # This single job builds the release binaries and updates the 'latest' pre-release.
  build-and-release:
    name: Build and Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-release-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-release-

      # Install 'cross' ONLY for the Windows build.
      # FIX: Added --force to overwrite existing binary.
      - name: Install cross
        run: cargo install cross --force

      # Add the necessary compilation targets for our desired binaries
      - name: Add Rust targets
        run: |
          rustup target add x86_64-pc-windows-gnu    # For Windows x64
          rustup target add aarch64-linux-android    # For Android ARM64

      # Set up the Android NDK, which is required for the Android target
      - name: Setup Android NDK
        uses: nttld/setup-ndk@v1
        id: ndk
        with:
          ndk-version: r26b

      # Build for Linux x64 (this is the host target, so no 'cross' needed)
      - name: Build for Linux x64
        run: cargo build --release --target x86_64-unknown-linux-gnu

      # Build for Windows x64 using 'cross'
      - name: Build for Windows x64
        run: cross build --release --target x86_64-pc-windows-gnu

      # Build for Android ARM64 by configuring cargo to use the NDK directly.
      - name: Build for Android ARM64
        env:
          # Define the NDK path for easy reference
          NDK_HOME: ${{ steps.ndk.outputs.ndk-path }}
          # Configure the C/C++ compiler and archiver for the build scripts (build.rs)
          CC: aarch64-linux-android33-clang
          CXX: aarch64-linux-android33-clang++
          AR: llvm-ar
          # Configure the Rust linker and library paths for the final linking stage
          CARGO_TARGET_AARCH64_LINUX_ANDROID_LINKER: aarch64-linux-android33-clang
          CARGO_TARGET_AARCH64_LINUX_ANDROID_RUSTFLAGS: -L ${NDK_HOME}/toolchains/llvm/prebuilt/linux-x86_64/sysroot/usr/lib/aarch64-linux-android/33
        run: |
          # Add the NDK tools to the PATH so the build scripts can find them
          export PATH="${{ steps.ndk.outputs.ndk-path }}/toolchains/llvm/prebuilt/linux-x86_64/bin:$PATH"
          cargo build --release --target aarch64-linux-android

      # Prepare the release directory and rename the binaries.
      - name: Prepare release artifacts
        run: |
          mkdir -p release
          cp target/x86_64-unknown-linux-gnu/release/zipsignerust release/zipsignerust-linux-x64
          cp target/x86_64-pc-windows-gnu/release/zipsignerust.exe release/zipsignerust-windows-x64.exe
          cp target/aarch64-linux-android/release/zipsignerust release/zipsignerust-android-arm64

      # Update the 'latest' pre-release with the new binaries.
      - name: Update Release
        uses: softprops/action-gh-release@v2
        with:
          # This will create or update a pre-release tagged as 'latest'
          tag_name: "latest"
          name: "Latest Development Build"
          # The body is updated with the latest commit SHA for tracking
          body: |
            Automated build from the latest commit on the `master` branch.

            **Commit:** `${{ github.sha }}`

            ---

            ### üì¶ Downloads

            Choose the binary for your platform:

            | Platform | Binary |
            | :--- | :--- |
            | **Linux x64** | `zipsignerust-linux-x64` |
            | **Windows x64** | `zipsignerust-windows-x64.exe` |
            | **Android ARM64** | `zipsignerust-android-arm64` |

            ---

            ‚ö†Ô∏è **Note:** This is a development build and includes a public test certificate. For production, you **must** use your own private signing keys.
          prerelease: true
          # This will overwrite existing assets with the same name
          files: |
            release/zipsignerust-linux-x64
            release/zipsignerust-windows-x64.exe
            release/zipsignerust-android-arm64
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
