name: Automatic Latest Release

on:
    push:
        branches: ["master"]
        tags: ["v*", "latest", "*.*.*"]
    workflow_dispatch:

permissions:
    contents: write

jobs:
    build:
        name: Build ${{ matrix.name }}
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                include:
                    - target: x86_64-unknown-linux-gnu
                      name: linux-x64
                    - target: aarch64-linux-android
                      name: android-arm64
                    - target: x86_64-pc-windows-gnu
                      name: windows-x64

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Rust
              run: |
                  rustup update stable
                  rustup target add ${{ matrix.target }}

            - name: Install Android NDK
              if: matrix.target == 'aarch64-linux-android'
              run: cargo install cargo-ndk --locked

            - name: Install MinGW (Windows)
              if: matrix.target == 'x86_64-pc-windows-gnu'
              run: sudo apt-get update && sudo apt-get install -y mingw-w64

            - name: Build Binary
              shell: bash
              run: |
                  mkdir -p dist
                  BIN_NAME="zipsignerust"
                  OUT_NAME="zipsignerust-${{ matrix.name }}"

                  if [[ "${{ matrix.target }}" == "aarch64-linux-android" ]]; then
                      cargo ndk -t arm64-v8a --platform 24 build --release
                      cp "target/${{ matrix.target }}/release/${BIN_NAME}" "dist/${OUT_NAME}"
                  else
                      cargo build --release --target ${{ matrix.target }}
                      # Handle Windows .exe extension
                      if [[ "${{ matrix.target }}" == *"windows"* ]]; then
                          BIN_NAME="${BIN_NAME}.exe"
                          OUT_NAME="${OUT_NAME}.exe"
                      fi
                      cp "target/${{ matrix.target }}/release/${BIN_NAME}" "dist/${OUT_NAME}"
                  fi

            - name: Upload Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: binary-${{ matrix.name }}
                  path: dist/*
                  if-no-files-found: error

    release:
        name: Publish Release
        needs: build
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Download Artifacts
              uses: actions/download-artifact@v4
              with:
                  path: all_dist
                  pattern: binary-*
                  merge-multiple: true

            - name: Determine Release Type
              id: release_type
              run: |
                  if [[ "${{ github.ref }}" == "refs/heads/master" ]] || [[ "${{ github.ref }}" == "refs/tags/latest" ]]; then
                      echo "type=rolling" >> $GITHUB_OUTPUT
                      echo "tag_name=latest" >> $GITHUB_OUTPUT
                      echo "title=ðŸš€ Latest Rolling Release" >> $GITHUB_OUTPUT
                  else
                      echo "type=versioned" >> $GITHUB_OUTPUT
                      echo "tag_name=${{ github.ref_name }}" >> $GITHUB_OUTPUT
                      echo "title=ðŸ“¦ Release ${{ github.ref_name }}" >> $GITHUB_OUTPUT
                  fi

            - name: Generate Release Notes
              id: notes
              run: |
                  chmod +x .github/scripts/gen_notes.sh

                  # Call the script to generate markdown
                  ./.github/scripts/gen_notes.sh \
                    "${{ steps.release_type.outputs.type }}" \
                    "${{ steps.release_type.outputs.tag_name }}" \
                    "${{ github.repository }}" \
                    "${{ github.run_id }}" \
                    "${{ github.sha }}" > release_notes.md

            - name: Publish via GitHub CLI
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  TAG: ${{ steps.release_type.outputs.tag_name }}
                  TITLE: ${{ steps.release_type.outputs.title }}
              run: |
                  echo "::group::Cleanup Old Release"
                  # Force delete old 'latest' release/tag synchronously
                  if [[ "$TAG" == "latest" ]]; then
                    gh release delete latest --cleanup-tag --yes || true
                    git push origin :refs/tags/latest || true
                    sleep 2
                  fi
                  echo "::endgroup::"

                  echo "::group::Create New Release"
                  gh release create "$TAG" all_dist/* \
                    --target ${{ github.sha }} \
                    --title "$TITLE" \
                    --notes-file release_notes.md \
                    --latest \
                    --verify-tag
                  echo "::endgroup::"

            - name: Release URL
              run: echo "::notice::ðŸŽ‰ Release ready at https://github.com/${{ github.repository }}/releases/latest"
