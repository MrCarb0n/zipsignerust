name: Automatic Latest Release

on:
    push:
        branches: ["master"]
        tags: ["v*", "latest", "*.*.*"]
    workflow_dispatch:

permissions:
    contents: write

jobs:
    build:
        name: Build ${{ matrix.name }}
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                include:
                    - target: x86_64-unknown-linux-gnu
                      name: linux-x64
                    - target: aarch64-linux-android
                      name: android-arm64
                    - target: x86_64-pc-windows-gnu
                      name: windows-x64

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Setup Rust
              run: |
                  rustup update stable
                  rustup target add ${{ matrix.target }}

            - name: Install Android NDK
              if: matrix.target == 'aarch64-linux-android'
              run: cargo install cargo-ndk --locked

            - name: Install MinGW (Windows)
              if: matrix.target == 'x86_64-pc-windows-gnu'
              run: sudo apt-get update && sudo apt-get install -y mingw-w64

            - name: Build Binary
              shell: bash
              run: |
                  mkdir -p dist
                  BIN_NAME="zipsignerust"
                  OUT_NAME="zipsignerust-${{ matrix.name }}"

                  if [[ "${{ matrix.target }}" == "aarch64-linux-android" ]]; then
                      cargo ndk -t arm64-v8a --platform 24 build --release
                      cp "target/${{ matrix.target }}/release/${BIN_NAME}" "dist/${OUT_NAME}"
                  else
                      cargo build --release --target ${{ matrix.target }}
                      if [[ "${{ matrix.target }}" == *"windows"* ]]; then
                          BIN_NAME="${BIN_NAME}.exe"
                          OUT_NAME="${OUT_NAME}.exe"
                      fi
                      cp "target/${{ matrix.target }}/release/${BIN_NAME}" "dist/${OUT_NAME}"
                  fi

            - name: Upload Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: binary-${{ matrix.name }}
                  path: dist/*
                  if-no-files-found: error

    release:
        name: Publish Release
        needs: build
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Download Artifacts
              uses: actions/download-artifact@v4
              with:
                  path: all_dist
                  pattern: binary-*
                  merge-multiple: true

            - name: Generate Release Notes
              id: notes
              run: |
                  chmod +x .github/scripts/gen_notes.sh
                  ./.github/scripts/gen_notes.sh \
                    "${{ (startsWith(github.ref, 'refs/tags/') && github.ref != 'refs/tags/latest') && 'versioned' || 'rolling' }}" \
                    "${{ (startsWith(github.ref, 'refs/tags/') && github.ref != 'refs/tags/latest') && github.ref_name || 'latest' }}" \
                    "${{ github.repository }}" \
                    "${{ github.run_id }}" \
                    "${{ github.sha }}" > release_notes.md

            - name: Set Environment Variables
              run: |
                  if [[ "${{ github.ref }}" == "refs/tags/"* ]] && [[ "${{ github.ref }}" != "refs/tags/latest" ]]; then
                     echo "TAG_NAME=${{ github.ref_name }}" >> $GITHUB_ENV
                     echo "TITLE=ðŸ“¦ Release ${{ github.ref_name }}" >> $GITHUB_ENV
                  else
                     echo "TAG_NAME=latest" >> $GITHUB_ENV
                     echo "TITLE=ðŸš€ Latest Rolling Release" >> $GITHUB_ENV
                  fi

            - name: Publish via GitHub CLI
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  TAG: ${{ env.TAG_NAME }}
              run: |
                  echo "::group::Cleanup Old Release"
                  if [[ "$TAG" == "latest" ]]; then
                    gh release delete latest --cleanup-tag --yes || true
                    git push origin :refs/tags/latest || true
                    sleep 2
                  fi
                  echo "::endgroup::"

                  echo "::group::Create New Release"
                  # REMOVED --verify-tag because we just deleted the tag!
                  gh release create "$TAG" all_dist/* \
                    --target ${{ github.sha }} \
                    --title "${{ env.TITLE }}" \
                    --notes-file release_notes.md \
                    --latest
                  echo "::endgroup::"

            - name: Release URL
              run: echo "::notice::ðŸŽ‰ Release ready at https://github.com/${{ github.repository }}/releases/latest"
