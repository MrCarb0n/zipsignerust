name: Automatic Latest Release

on:
    push:
        branches: ["master"]
        tags: ["v*", "latest", "*.*.*"]
    workflow_dispatch:

permissions:
    contents: write

jobs:
    build:
        name: Build ${{ matrix.name }}
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                include:
                    - target: x86_64-unknown-linux-gnu
                      os_package: ""
                      name: linux-x64
                    - target: aarch64-linux-android
                      os_package: ""
                      name: android-arm64
                    - target: x86_64-pc-windows-gnu
                      os_package: mingw-w64
                      name: windows-x64

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Install Dependencies
              if: matrix.os_package != ''
              run: sudo apt-get update && sudo apt-get install -y ${{ matrix.os_package }}

            - name: Setup Rust
              run: |
                  rustup update stable
                  rustup target add ${{ matrix.target }}

            - name: Install cargo-ndk
              if: matrix.target == 'aarch64-linux-android'
              run: cargo install cargo-ndk --locked

            - name: Build Binary
              shell: bash
              run: |
                  mkdir -p dist

                  if [[ "${{ matrix.target }}" == "aarch64-linux-android" ]]; then
                      echo "Building for Android ${{ matrix.target }}..."
                      cargo ndk -t arm64-v8a --platform 24 build --release
                      cp "target/${{ matrix.target }}/release/zipsignerust" "dist/zipsignerust-${{ matrix.name }}"
                  else
                      echo "Building for ${{ matrix.target }}..."
                      cargo build --release --target ${{ matrix.target }}

                      BINARY_NAME="zipsignerust"
                      OUTPUT_NAME="zipsignerust-${{ matrix.name }}"

                      if [[ "${{ matrix.target }}" == *"windows"* ]]; then
                          BINARY_NAME="${BINARY_NAME}.exe"
                          OUTPUT_NAME="${OUTPUT_NAME}.exe"
                      fi

                      cp "target/${{ matrix.target }}/release/${BINARY_NAME}" "dist/${OUTPUT_NAME}"
                  fi

                  ls -lh dist/

            - name: Upload Artifact
              uses: actions/upload-artifact@v4
              with:
                  name: binary-${{ matrix.name }}
                  path: dist/*
                  if-no-files-found: error

    release:
        name: Create Release
        needs: build
        runs-on: ubuntu-latest
        permissions:
            contents: write

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Download All Artifacts
              uses: actions/download-artifact@v4
              with:
                  path: all_dist
                  pattern: binary-*
                  merge-multiple: true

            - name: Determine Release Type
              id: release_type
              run: |
                  if [[ "${{ github.ref }}" == "refs/heads/master" ]]; then
                      echo "type=rolling" >> $GITHUB_OUTPUT
                      echo "tag_name=latest" >> $GITHUB_OUTPUT
                      echo "release_name=Latest Rolling Release" >> $GITHUB_OUTPUT
                  elif [[ "${{ github.ref }}" == "refs/tags/latest" ]]; then
                      echo "type=rolling" >> $GITHUB_OUTPUT
                      echo "tag_name=latest" >> $GITHUB_OUTPUT
                      echo "release_name=Latest Rolling Release" >> $GITHUB_OUTPUT
                  else
                      echo "type=versioned" >> $GITHUB_OUTPUT
                      echo "tag_name=${{ github.ref_name }}" >> $GITHUB_OUTPUT
                      echo "release_name=Release ${{ github.ref_name }}" >> $GITHUB_OUTPUT
                  fi

            - name: Delete Existing 'latest' Release (if rolling)
              if: steps.release_type.outputs.type == 'rolling'
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  echo "Checking for existing 'latest' release..."
                  RELEASE_DATA=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
                    "https://api.github.com/repos/${{ github.repository }}/releases/tags/latest")

                  RELEASE_ID=$(echo "$RELEASE_DATA" | jq -r '.id // empty')

                  if [ -n "$RELEASE_ID" ] && [ "$RELEASE_ID" != "null" ]; then
                      echo "Found existing release with ID: $RELEASE_ID. Deleting..."
                      curl -s -X DELETE -H "Authorization: token $GITHUB_TOKEN" \
                        "https://api.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID"
                      echo "Existing release deleted."
                  else
                      echo "No existing 'latest' release found."
                  fi

            - name: Create 'latest' Tag for Rolling Release
              if: steps.release_type.outputs.type == 'rolling'
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

                  # Delete the existing tag locally and remotely
                  git tag -d latest 2>/dev/null || true
                  git push origin :refs/tags/latest 2>/dev/null || true

                  # Create and push the new tag
                  git tag -fa latest -m "Latest rolling release"
                  git push origin latest -f

            - name: Generate Release Notes
              id: notes
              run: |
                  SHORT_SHA=$(echo ${GITHUB_SHA} | cut -c1-8)
                  DATE=$(date +'%Y-%m-%d %H:%M:%S UTC')
                  DATE_BADGE=$(echo ${DATE// /%20})

                  # Get appropriate commit history based on release type
                  if [[ "${{ steps.release_type.outputs.type }}" == "versioned" ]]; then
                      # For versioned releases, get changes since the last tag
                      PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
                      if [ -n "$PREV_TAG" ]; then
                          MSG=$(git log --pretty=format:"- %s (%h)" $PREV_TAG..HEAD)
                          STATS=$(git diff --stat $PREV_TAG..HEAD)
                      else
                          MSG=$(git log --pretty=format:"- %s (%h)")
                          STATS=$(git show --stat HEAD)
                      fi
                  else
                      # For rolling releases, get last 10 commits
                      MSG=$(git log -10 --pretty=format:"- %s (%h)")
                      if git rev-parse HEAD~1 >/dev/null 2>&1; then
                          STATS=$(git diff --stat HEAD~1 HEAD)
                      else
                          STATS=$(git show --stat HEAD)
                      fi
                  fi

                  # Hardcode Author for consistency
                  AUTHOR_BADGE="Tiash%20%2F%20@MrCarb0n"
                  AUTHOR_URL="https://github.com/MrCarb0n"

                  # Release configuration
                  DL_URL="https://github.com/${GITHUB_REPOSITORY}/releases/download/${{ steps.release_type.outputs.tag_name }}"
                  WORKFLOW_URL="https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}"

                  # Different headers for different release types
                  if [[ "${{ steps.release_type.outputs.type }}" == "versioned" ]]; then
                      TITLE_HEADER="**üì¶ Version ${{ steps.release_type.outputs.tag_name }} Release**"
                  else
                      TITLE_HEADER="**üöÄ Automated Rolling Release**"
                  fi

                  # Group echo statements to generate the release notes in a single file
                  {
                    echo '<div align="center">'
                    echo ""
                    echo '```'
                    echo ' _____ _     _____ _             _____         _   '
                    echo '|__   |_|___|   __|_|___ ___ ___| __  |_ _ ___| |_ '
                    echo '|   __| | . |__   | | . |   | -_|    -| | |_ -|  _|'
                    echo '|_____|_|  _|_____|_|_  |_|_|___|__|__|___|___|_|  '
                    echo '        |_|         |___|                          '
                    echo '```'
                    echo ""
                    echo "[![Build Date](https://img.shields.io/badge/Date-${DATE_BADGE}-blue)](${WORKFLOW_URL}) [![Commit](https://img.shields.io/badge/Commit-${SHORT_SHA}-informational)](${WORKFLOW_URL}) [![Author](https://img.shields.io/badge/Author-${AUTHOR_BADGE}-success)](${AUTHOR_URL})"
                    echo '</div>'
                    echo ""
                    echo "## üìã Summary of Changes"
                    echo '```'

                    echo "$MSG"

                    echo '```'
                    echo ""
                    echo "## üìä Code Impact"
                    echo '```diff'
                    echo "${STATS}"
                    echo '```'
                    echo ""
                    echo "## üì¶ Artifacts"
                    echo "| Platform | Architecture | File | Size |"
                    echo "| :--- | :--- | :--- | :--- |"

                    for f in all_dist/*; do
                      SIZE=$(du -h "$f" | cut -f1)
                      FILE=$(basename "$f")
                      case "$FILE" in
                        *linux*) PLATFORM="üêß Linux"; ARCH="x86_64";;
                        *android*) PLATFORM="ü§ñ Android"; ARCH="ARM64";;
                        *windows*) PLATFORM="ü™ü Windows"; ARCH="x86_64";;
                        *) PLATFORM="Unknown"; ARCH="Unknown";;
                      esac
                      echo "| $PLATFORM | $ARCH | [$FILE]($DL_URL/$FILE) | $SIZE |"
                    done

                    echo ""
                    echo '<div align="center">'
                    echo ""
                    echo "$TITLE_HEADER"
                    echo ""
                    echo '</div>'
                  } > release_notes.md

            - name: Publish Release
              uses: softprops/action-gh-release@v2
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  tag_name: ${{ steps.release_type.outputs.tag_name }}
                  name: ${{ steps.release_type.outputs.release_name }}
                  body_path: release_notes.md
                  files: |
                      all_dist/*
                  prerelease: false
                  draft: false
                  make_latest: true
                  replace_latest: true
